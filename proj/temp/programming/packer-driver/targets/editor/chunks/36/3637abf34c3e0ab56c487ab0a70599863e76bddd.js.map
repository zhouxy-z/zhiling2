{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/PlayerModule.ts"],"names":["PlayerModule","MsgTypeRet","CfgMgr","EventMgr","Evt_ConfigData_Update","Evt_FightChange","Evt_Passive_Skill_Update","Evt_PlayerBaseInfoChange","Evt_Role_Upgrade","SyncGameData","Session","BeforeGameUtils","Second","GameSet","MsgPanel","RewardTips","ShowHeroPanel","CardType","Tips","RoleTuPoResultPanel","SettingPasswordPanel","SettingPasswordSuccessPanel","UserInfoPanel","PlayerData","ChangeBaseInfoErrorCodeType","constructor","tick","changeBaseInfoErrorStr","toHashMapObj","ErrorInvalidNameLength","ErrorInvalidContactWechat","ErrorInvalidContactQQ","ErrorNameExists","ErrorNameSuspect","ErrorContactWechatSuspect","fightChangeOff","timeNumber","on","TotalBattlePowerChangePush","onPlayerPower","UpgradeRoleRet","onUpgradeRoleRet","SetConfigDataRet","onUpdateRoleCfg","UpgradePassiveSkillRet","onUpgradePassiveSkill","GetPlayerViewInfoRet","onGetPlayerViewInfoRet","ChangeNameRet","onChangeNameRet","ChangeContactQQRet","onChangeContactQQRet","ChangeContactWechatRet","onChangeContactWechatRet","ResetRoleRet","onResetRoleRet","RoleTypeMaxSumBattlePowerChangePush","onRoleTypeMaxSumBattlePowerChange","ResetPasswordSendRet","onResetPasswordSendRet","ResetPasswordValidRet","onResetPasswordValidRet","RegisterUpdate","update","data","roleInfo","battle_power","total_battle_power","emit","role_type_max_sum_battle_power","old","JSON","parse","stringify","GetRoleById","role","id","AddRole","isUpgrade","level","stdLv","GetRoleLevel","type","BreakItem","length","Show","config_data","code","player_view_info","dt","timeMap","CycleTimeMap","now","serverTime","k","t","Number","start","showChangeInfoErrorCode","name","name_changed_times","onChangeBaseInfo","contact_qq","contact_wechat","ResetRoleLv","return_items","msg","Hide","is_password","errorStr","clearTime","setTimeout","clearTimeout"],"mappings":"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","sourcesContent":["// ItemChangePush\r\nimport { MsgTypeRet } from \"../../MsgType\";\r\nimport { CfgMgr, StdRoleLevel } from \"../../manager/CfgMgr\";\r\nimport { EventMgr, Evt_ConfigData_Update, Evt_FightChange, Evt_Item_Change, Evt_Passive_Skill_Update, Evt_PlayerBaseInfoChange, Evt_Role_Upgrade } from \"../../manager/EventMgr\";\r\nimport { SyncGameData } from \"../../net/MsgProxy\";\r\nimport { Session } from \"../../net/Session\";\r\nimport { BeforeGameUtils } from \"../../utils/BeforeGameUtils\";\r\nimport Logger from \"../../utils/Logger\";\r\nimport { Second } from \"../../utils/Utils\";\r\nimport { GameSet } from \"../GameSet\";\r\nimport { MsgPanel } from \"../common/MsgPanel\";\r\nimport { RewardTips } from \"../common/RewardTips\";\r\nimport { ShowHeroPanel } from \"../common/ShowHeroPanel\";\r\nimport { CardType } from \"../home/panel/Card\";\r\nimport { HomeUI } from \"../home/panel/HomeUI\";\r\nimport { Tips } from \"../login/Tips\";\r\nimport { RoleTuPoPanel } from \"../role/RoleTuPoPanel\";\r\nimport { RoleTuPoResultPanel } from \"../role/RoleTuPoResultPanel\";\r\nimport { SettingPasswordPanel } from \"../setting/SettingPasswordPanel\";\r\nimport { SettingPasswordSuccessPanel } from \"../setting/SettingPasswordSuccessPanel\";\r\nimport { UserInfoPanel } from \"../userInfo/UserInfoPanel\";\r\nimport PlayerData, {} from \"./PlayerData\"\r\n import {SPlayerDataItem, SPlayerDataRole,SPlayerDataSkill,SPlayerViewInfo} from \"./PlayerStruct\";\r\n/**修改玩家基础信息错误码类型*/\r\nenum ChangeBaseInfoErrorCodeType {\r\n    ErrorInvalidNameLength    = 100, // 名字长度不合法\r\n\tErrorInvalidContactWechat = 101, // 微信号码不合法\r\n\tErrorInvalidContactQQ     = 102, // QQ号码不合法\r\n\tErrorNameExists           = 103, // 名字已经存在\r\n\tErrorNameSuspect          = 104, // 名字包含敏感词\r\n\tErrorContactWechatSuspect = 105, // 微信号包含敏感词\r\n}\r\nexport class PlayerModule {\r\n    private tick = 0;\r\n    private changeBaseInfoErrorStr:{[key: string]: string} = BeforeGameUtils.toHashMapObj(\r\n        ChangeBaseInfoErrorCodeType.ErrorInvalidNameLength,\"名字长度不合法\",\r\n        ChangeBaseInfoErrorCodeType.ErrorInvalidContactWechat,\"微信号码不合法\",\r\n        ChangeBaseInfoErrorCodeType.ErrorInvalidContactQQ,\"QQ号码不合法\",\r\n        ChangeBaseInfoErrorCodeType.ErrorNameExists,\"名字已经存在\",\r\n        ChangeBaseInfoErrorCodeType.ErrorNameSuspect,\"名字包含敏感词\",\r\n        ChangeBaseInfoErrorCodeType.ErrorContactWechatSuspect,\"微信号包含敏感词\",\r\n        \r\n    );\r\n    constructor() {\r\n        Session.on(MsgTypeRet.TotalBattlePowerChangePush, this.onPlayerPower, this);\r\n        Session.on(MsgTypeRet.UpgradeRoleRet, this.onUpgradeRoleRet, this);\r\n        Session.on(MsgTypeRet.SetConfigDataRet, this.onUpdateRoleCfg, this);\r\n        Session.on(MsgTypeRet.UpgradePassiveSkillRet, this.onUpgradePassiveSkill, this);\r\n        Session.on(MsgTypeRet.GetPlayerViewInfoRet, this.onGetPlayerViewInfoRet, this);\r\n        Session.on(MsgTypeRet.ChangeNameRet, this.onChangeNameRet, this);\r\n        Session.on(MsgTypeRet.ChangeContactQQRet, this.onChangeContactQQRet, this);\r\n        Session.on(MsgTypeRet.ChangeContactWechatRet, this.onChangeContactWechatRet, this);\r\n        Session.on(MsgTypeRet.ResetRoleRet, this.onResetRoleRet, this);\r\n        Session.on(MsgTypeRet.RoleTypeMaxSumBattlePowerChangePush, this.onRoleTypeMaxSumBattlePowerChange, this);\r\n        Session.on(MsgTypeRet.ResetPasswordSendRet, this.onResetPasswordSendRet, this);\r\n        Session.on(MsgTypeRet.ResetPasswordValidRet, this.onResetPasswordValidRet, this);\r\n        GameSet.RegisterUpdate(this.update, this);\r\n    }\r\n\r\n    protected fightChangeOff = false;\r\n    protected async onPlayerPower(data: { total_battle_power: number, change_battle_power: number }) {\r\n        PlayerData.roleInfo.battle_power = data.total_battle_power;\r\n        if (this.fightChangeOff) return;\r\n        this.fightChangeOff = true;\r\n        await Second(0.1);\r\n        this.fightChangeOff = false;\r\n        EventMgr.emit(Evt_FightChange);\r\n    }\r\n\r\n    private onRoleTypeMaxSumBattlePowerChange(data: { role_type_max_sum_battle_power: number}) {\r\n        PlayerData.roleInfo.role_type_max_sum_battle_power = data.role_type_max_sum_battle_power;\r\n    }\r\n\r\n    private onUpgradeRoleRet(data: { role: SPlayerDataRole }): void {\r\n        let old:SPlayerDataRole = JSON.parse(JSON.stringify(PlayerData.GetRoleById(data.role.id)));\r\n        PlayerData.AddRole(data.role);\r\n        let isUpgrade: boolean = false;\r\n        //升级或突破\r\n        if (data.role.level > old.level) {\r\n            let stdLv: StdRoleLevel = CfgMgr.GetRoleLevel(old.type, old.level);\r\n            //突破\r\n            if (stdLv && stdLv.BreakItem && stdLv.BreakItem.length > 0) {\r\n                RoleTuPoResultPanel.Show(data.role.id, true);\r\n            } else {\r\n                isUpgrade = true;\r\n            }\r\n        }\r\n        \r\n        EventMgr.emit(Evt_Role_Upgrade, data.role.id, isUpgrade);\r\n    }\r\n\r\n    private onUpdateRoleCfg(data: { config_data: { [key: number]: number } }) {\r\n        PlayerData.roleInfo.config_data = data.config_data;\r\n        if (SyncGameData(data.config_data)) EventMgr.emit(Evt_ConfigData_Update);\r\n    }\r\n    private onUpgradePassiveSkill(data: { role: SPlayerDataRole }): void {\r\n        PlayerData.AddRole(data.role);\r\n        EventMgr.emit(Evt_Passive_Skill_Update, data.role.id);\r\n    }\r\n    private onGetPlayerViewInfoRet(data: {code: number, player_view_info:SPlayerViewInfo}):void{\r\n        if(data.code == 0){\r\n            UserInfoPanel.Show(data.player_view_info);\r\n        }\r\n    }\r\n    private update(dt: number) {\r\n        this.tick += dt;\r\n        if (this.tick >= 1) {\r\n            this.tick = 0;\r\n            const timeMap = PlayerData.CycleTimeMap;\r\n            if (!timeMap) return;\r\n            let now = PlayerData.serverTime;\r\n            for (let k in timeMap) {\r\n                let t = Number(k);\r\n                let start = timeMap[k];\r\n                if (now - start >= t) {\r\n                    timeMap[k] = now;\r\n                    // 此处运行更新数据,t表示时间间隔(秒)\r\n\r\n                }\r\n            }\r\n        }\r\n    }\r\n    private onChangeNameRet(data: {code: number, name:string, name_changed_times:number}):void{\r\n        if(data.code){\r\n            this.showChangeInfoErrorCode(data.code);\r\n            return;\r\n        } \r\n        PlayerData.roleInfo.name = data.name;\r\n        PlayerData.roleInfo.name_changed_times = data.name_changed_times;\r\n        this.onChangeBaseInfo();\r\n    }\r\n    private onChangeContactQQRet(data: {code: number, name:string, contact_qq:string}):void{\r\n        if(data.code){\r\n            this.showChangeInfoErrorCode(data.code);\r\n            return;\r\n        } \r\n        PlayerData.roleInfo.contact_qq = data.contact_qq;\r\n        this.onChangeBaseInfo();\r\n    }\r\n    private onChangeContactWechatRet(data: {code: number, contact_wechat:string}):void{\r\n        if(data.code){\r\n            this.showChangeInfoErrorCode(data.code);\r\n            return;\r\n        } \r\n        PlayerData.roleInfo.contact_wechat = data.contact_wechat;\r\n        this.onChangeBaseInfo();\r\n    }\r\n    private onResetRoleRet(data: {role:SPlayerDataRole, return_items:SPlayerDataItem[]}):void{\r\n        if(!data.role) return;\r\n        PlayerData.AddRole(data.role);\r\n        EventMgr.emit(Evt_Role_Upgrade, data.role.id);\r\n        ShowHeroPanel.Show(data.role, null, CardType.ResetRoleLv, ()=>{\r\n            if(data.return_items && data.return_items.length){\r\n                RewardTips.Show(data.return_items);\r\n            }\r\n            \r\n        });\r\n    }\r\n    private onResetPasswordSendRet(data: {code: number, msg: string}):void{\r\n        if(data.code > 0){\r\n            Tips.Show(data.msg);\r\n            return;\r\n        }\r\n        MsgPanel.Show(\"验证码已下发\")\r\n    }\r\n    private onResetPasswordValidRet(data: {code: number, msg: string}):void{\r\n        if(data.code > 0){\r\n            Tips.Show(data.msg);\r\n            return;\r\n        }\r\n        SettingPasswordSuccessPanel.Show();\r\n        SettingPasswordPanel.Hide();\r\n        PlayerData.roleInfo.is_password = true;\r\n    }\r\n    private showChangeInfoErrorCode(code:number):void{\r\n        let errorStr:string = this.changeBaseInfoErrorStr[code];\r\n        if(errorStr){\r\n            MsgPanel.Show(errorStr);\r\n        }\r\n        \r\n    }\r\n    private timeNumber:any = null;\r\n    private onChangeBaseInfo():void{\r\n        this.clearTime();\r\n        this.timeNumber = setTimeout(()=>{\r\n            MsgPanel.Show(`修改成功！`);\r\n            this.clearTime();\r\n            EventMgr.emit(Evt_PlayerBaseInfoChange);\r\n        }, 200);\r\n    }\r\n    private clearTime():void{\r\n        if(this.timeNumber){\r\n            clearTimeout(this.timeNumber);\r\n            this.timeNumber = null;\r\n        }\r\n    }\r\n}\r\n"]}