{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/fight/opOutput/Out_TerrainToTerrain.ts"],"names":["Out_TerrainToTerrain","BattleBaseComp","battleDataMgr","start","data","toMove","exit","reset","success","fromTerrainIsA","isPlayerA","fromTerrainPlayerId","toTerrainIsA","toTerrainPlayerId","manual","startCardLocation","getPlayerCardLocation","card","instId","targetCardLocation","getPlayerAreaEmptyCardLocation","toTerrainInstId","scene","CardAreaMove","areaIdx","cardIdx","fromCardPower","getPlayerCardPower","fromTerrainData","getPlayerTerrainFormId","fromTerrainInstId","offsetPower","cardMul","finalValue","fromTotalPower","getPlayerTerrainTotalPow","FlushAreaPower","toTerrainData","toTotalPower","addCardPower","power"],"mappings":"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","sourcesContent":["import proto from \"../../../net/Protocol\";\r\nimport { BattleBaseComp } from \"../../battle/BattleBaseComp\";\r\nimport { battleDataMgr } from \"../../battle/BattleDataMgr\";\r\nimport { CardLocation } from \"../../player/PlayerStruct\";\r\n/**\r\n * 区域上的卡牌移动（包括手动移动动移动 ）\r\n */\r\nexport class Out_TerrainToTerrain extends BattleBaseComp<proto.base.IBattleRoomOpOutput_TerrainToTerrain> {\r\n    \r\n    protected start(): void {\r\n        if (this.data) {\r\n            this.toMove();\r\n        } else {\r\n            this.exit();\r\n        }\r\n    }\r\n\r\n    protected reset(): void {\r\n       \r\n    }\r\n\r\n    private async toMove() {\r\n        if (this.data.success) {\r\n            //移动成功\r\n\r\n            //开始移动的地形是否第一视觉玩家\r\n            let fromTerrainIsA: boolean = battleDataMgr.isPlayerA(this.data.fromTerrainPlayerId);\r\n            //目标去到的地形是否第一视觉玩家\r\n            let toTerrainIsA: boolean = battleDataMgr.isPlayerA(this.data.toTerrainPlayerId);\r\n            //手动移动并且第一视觉方移动不做处理（因为在操作移动上已修改数据了）\r\n            if (this.data.manual && fromTerrainIsA && toTerrainIsA) {\r\n                this.exit();\r\n                return;\r\n            }\r\n            //移动卡牌的开始位置\r\n            let startCardLocation: CardLocation = battleDataMgr.getPlayerCardLocation(this.data.fromTerrainPlayerId, this.data.card.instId);\r\n            //移动卡牌的目标位置\r\n            let targetCardLocation: CardLocation = battleDataMgr.getPlayerAreaEmptyCardLocation(this.data.toTerrainPlayerId, this.data.toTerrainInstId);\r\n            \r\n            /**\r\n            * TODO 这里实现起移动效果 (只做了简单位置交换)\r\n            */\r\n            await this.scene.CardAreaMove(battleDataMgr.isPlayerA(this.data.toTerrainPlayerId), targetCardLocation.areaIdx, targetCardLocation.cardIdx, this.data);\r\n            \r\n            //减掉移动来源的卡牌战力\r\n            let fromCardPower: number = battleDataMgr.getPlayerCardPower(this.data.fromTerrainPlayerId, this.data.card.instId);\r\n            let fromTerrainData: proto.base.IBattleRoomTerrainPlayerData = battleDataMgr.getPlayerTerrainFormId(this.data.fromTerrainPlayerId, this.data.fromTerrainInstId);\r\n            let offsetPower: number = fromTerrainData.cardMul.finalValue * fromCardPower;\r\n            let fromTotalPower = battleDataMgr.getPlayerTerrainTotalPow(this.data.fromTerrainPlayerId, startCardLocation.areaIdx);\r\n            this.scene.FlushAreaPower(fromTerrainIsA, startCardLocation.areaIdx, fromTotalPower - offsetPower);\r\n\r\n            //增加移动目的区域的战力\r\n            let toTerrainData: proto.base.IBattleRoomTerrainPlayerData = battleDataMgr.getPlayerTerrainFormId(this.data.toTerrainPlayerId, this.data.toTerrainInstId);\r\n            let toTotalPower: number = battleDataMgr.getPlayerTerrainTotalPow(this.data.toTerrainPlayerId, targetCardLocation.areaIdx);\r\n            let addCardPower: number = this.data.card.power ? this.data.card.power.finalValue * toTerrainData.cardMul.finalValue : 0;\r\n            this.scene.FlushAreaPower(fromTerrainIsA, targetCardLocation.areaIdx, toTotalPower + addCardPower);\r\n            this.exit();\r\n        } else {\r\n            /**\r\n             * TODO 暂时没有移动失败的表现\r\n             */\r\n            this.exit();\r\n        }\r\n    \r\n    }\r\n\r\n}"]}