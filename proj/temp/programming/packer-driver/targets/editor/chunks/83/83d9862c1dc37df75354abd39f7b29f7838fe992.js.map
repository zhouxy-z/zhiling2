{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/shop/ShopDefinePage.ts"],"names":["ShopDefinePage","Input","Label","Slider","Sprite","SpriteFrame","UITransform","path","PlayerData","Req","Route","CfgMgr","AutoScroller","AsyncComponent","ShopItem","Tips","ResMgr","folder_item","Session","DateUtils","scroller","icon","numLab","nameLab","descLab","slider","progress","costIcon","costLab","timeLab","indexIds","selectShop","costCfg","limit","buyCount","refreshShop","undefined","onLoad","node","getChildByPath","getComponent","addComponent","SetHandle","updateItem","bind","on","onSelect","EventType","TOUCH_END","onDel","onAdd","onBuy","onSlide","sort","a","b","aseed","count","GetCommShopItem","id","Order","bseed","Show","active","hasLoad","loadSub","updateData","Hide","exceptIndex","adshops","items","indexId","content","GetShopByID","shopIndexId","shop","refreshTime","adShopItems","forEach","value","push","shopItems","datas","concat","length","UpdateDatas","SelectFirst","parent","update","dt","size","contentSize","setContentSize","width","residueTime","Math","max","floor","ServerTime","string","FormatTime","shop_index","sendAsync","item","data","index","shopItem","SetData","stdItem","Getitem","GoodsID","ItemName","Remark","GoodAmount","updateProgress","e","ceil","url","join","CostID","Icon","spriteFrame","LoadResAbSub","CostNumber","toString","buy_item","buyId","Id","Send"],"mappings":"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","sourcesContent":["import { PlayerData } from \"../player/PlayerData\";\r\nimport proto, { Req, Route } from \"../../net/Protocol\";\r\nimport { CfgMgr, StdShopCommodity } from \"../../manager/CfgMgr\";\r\nimport { AutoScroller } from \"../../component/AutoScroller\";\r\nimport { AsyncComponent } from \"../common/AsyncComponent\";\r\nimport { Input, Label, Node, Slider, Sprite, SpriteFrame, UITransform, path } from \"cc\";\r\nimport { ShopItem } from \"./ShopItem\";\r\nimport { Tips } from \"../common/Tips\";\r\nimport { ResMgr, folder_item } from \"../../manager/ResMgr\";\r\nimport { Session } from \"../../net/Session\";\r\nimport { IPanelPage } from \"../common/IPanelPage\";\r\nimport { DateUtils } from \"../../utils/DateUtils\";\r\n\r\n/**将shopitem再次封装，用于动态绑定shopIndexId的语法糖提示 */\r\ninterface IShopItem extends proto.base.IShopItem {\r\n    shopIndexId: number;\r\n}\r\n\r\nexport class ShopDefinePage extends AsyncComponent implements IPanelPage {\r\n    protected scroller: AutoScroller;\r\n    protected icon: Sprite;\r\n    protected numLab: Label;\r\n    protected nameLab: Label;\r\n    protected descLab: Label;\r\n    protected slider: Slider;\r\n    protected progress: Node;\r\n    protected costIcon: Sprite;\r\n    protected costLab: Label;\r\n    protected timeLab: Label;\r\n\r\n    protected indexIds = [];\r\n    protected selectShop: IShopItem;\r\n    protected costCfg: StdShopCommodity;\r\n    protected limit: number;\r\n    protected buyCount = 0;\r\n    protected refreshShop: proto.base.IShopIndexContent = undefined;\r\n\r\n    protected onLoad() {\r\n        this.scroller = this.node.getChildByPath(\"shopList\").getComponent(AutoScroller);\r\n        if(!this.scroller)this.scroller = this.node.getChildByPath(\"shopList\").addComponent(AutoScroller);\r\n        this.scroller.SetHandle(this.updateItem.bind(this));\r\n        this.scroller.node.on('select', this.onSelect, this);\r\n        this.icon = this.node.getChildByPath(\"infoView/itemShow/icon\").getComponent(Sprite);\r\n        this.numLab = this.node.getChildByPath(\"infoView/itemShow/numLab\").getComponent(Label);\r\n        this.nameLab = this.node.getChildByPath(\"infoView/nameLab\").getComponent(Label);\r\n        this.descLab = this.node.getChildByPath(\"infoView/descLab\").getComponent(Label);\r\n        this.slider = this.node.getChildByPath(\"infoView/Slider\").getComponent(Slider);\r\n        this.progress = this.node.getChildByPath(\"infoView/Slider/progress\");\r\n        this.costIcon = this.node.getChildByPath(\"infoView/costLayout/icon\").getComponent(Sprite);\r\n        this.costLab = this.node.getChildByPath(\"infoView/costLayout/cost\").getComponent(Label);\r\n        this.timeLab = this.node.getChildByPath(\"timeCont/timeLab\").getComponent(Label);\r\n        this.node.getChildByPath(\"infoView/del\").on(Input.EventType.TOUCH_END, this.onDel, this);\r\n        this.node.getChildByPath(\"infoView/add\").on(Input.EventType.TOUCH_END, this.onAdd, this);\r\n        this.node.getChildByPath(\"infoView/buyBtn\").on(Input.EventType.TOUCH_END, this.onBuy, this);\r\n        this.slider.node.on('slide', this.onSlide, this);\r\n        super.onLoad();\r\n    }\r\n\r\n    protected sort(a: proto.base.IShopItem, b: proto.base.IShopItem) {\r\n        let aseed = (a.count < 0 ? 1 : 0) * 10000 + CfgMgr.GetCommShopItem(a.id).Order;\r\n        let bseed = (b.count < 0 ? 1 : 0) * 10000 + CfgMgr.GetCommShopItem(b.id).Order;\r\n        return aseed - bseed;\r\n    }\r\n\r\n    async Show(indexIds: number[]) {\r\n        this.selectShop = undefined;\r\n        this.node.active = true;\r\n        if (!this.hasLoad) await this.loadSub;\r\n        this.indexIds = indexIds;\r\n        this.updateData();\r\n    }\r\n    async Hide() {\r\n        if (!this.hasLoad) await this.loadSub;\r\n        this.node.active = false;\r\n    }\r\n\r\n    protected updateData(exceptIndex?: number) {\r\n        // 将相同tabSort的商店合并\r\n        let adshops: IShopItem[] = [];\r\n        let items: IShopItem[] = [];\r\n        this.refreshShop = undefined;\r\n        for (let indexId of this.indexIds) {\r\n            let content = PlayerData.GetShopByID(indexId);\r\n            if (content.shopIndexId != exceptIndex) {\r\n                if (!this.refreshShop || this.refreshShop.shop.refreshTime > content.shop.refreshTime) this.refreshShop = content;\r\n            }\r\n            content.shop.adShopItems.forEach(value => {\r\n                value['shopIndexId'] = content.shopIndexId;\r\n                adshops.push(value as IShopItem);\r\n            })\r\n            content.shop.shopItems.forEach(value => {\r\n                value['shopIndexId'] = content.shopIndexId;\r\n                items.push(value as IShopItem);\r\n            })\r\n        }\r\n        // 排序\r\n        adshops.sort(this.sort);\r\n        items.sort(this.sort);\r\n        let datas = adshops.concat(items);\r\n        if (datas.length) {\r\n            this.scroller.UpdateDatas(datas);\r\n            this.scroller.SelectFirst();\r\n            this.nameLab.node.parent.active = true;\r\n        } else {\r\n            this.nameLab.node.parent.active = false;\r\n        }\r\n    }\r\n\r\n    protected update(dt: number): void {\r\n        let size = this.slider.node.getComponent(UITransform).contentSize;\r\n        this.progress.getComponent(UITransform).setContentSize(this.slider.progress * size.width, 13.448);\r\n\r\n        if (this.refreshShop) {\r\n            this.timeLab.node.parent.active = true;\r\n            let residueTime: number = Math.max(Math.floor(this.refreshShop.shop.refreshTime - DateUtils.ServerTime), 0);\r\n            this.timeLab.string = \"刷新时间：\" + DateUtils.FormatTime(residueTime, \"%{hh}:%{mm}:%{ss}\");\r\n            if (residueTime <= 0) {\r\n                let shop_index = new Req[\"shop.protocol.getindex\"]();\r\n                shop_index.shopIndexId = undefined;//[this.refreshShop.shopIndexId];\r\n                Session.sendAsync(Route[\"shop.protocol.getindex\"], shop_index);\r\n                this.updateData(this.refreshShop.shopIndexId);\r\n            } else {\r\n\r\n            }\r\n        } else {\r\n            this.timeLab.node.parent.active = false;\r\n            this.timeLab.string = \"刷新时间：--:--:--\";\r\n        }\r\n    }\r\n\r\n    protected updateItem(item: Node, data: proto.base.IShopItem, index: number) {\r\n        let shopItem = item.getComponent(ShopItem);\r\n        if (!shopItem) shopItem = item.addComponent(ShopItem);\r\n        shopItem.SetData(data);\r\n    }\r\n\r\n    protected onSelect(index: number, item: Node, data: any) {\r\n        if (this.selectShop != data) this.buyCount = 1;\r\n        this.selectShop = data;\r\n        this.costCfg = CfgMgr.GetCommShopItem(data.id);\r\n        let stdItem = CfgMgr.Getitem(this.costCfg.GoodsID[0]);\r\n        this.nameLab.string = stdItem.ItemName;\r\n        this.descLab.string = stdItem.Remark;\r\n        this.nameLab.node.parent.active = true;\r\n        this.limit = CfgMgr.GetCommShopItem(this.selectShop.id)?.GoodAmount || 1000;\r\n        this.updateProgress();\r\n    }\r\n\r\n    protected onSlide(e?: Slider) {\r\n        if (!this.selectShop) return;\r\n        this.buyCount = Math.max(Math.ceil(this.limit * this.slider.progress), 1);\r\n        this.updateProgress();\r\n    }\r\n    protected async updateProgress() {\r\n        this.slider.progress = this.buyCount / this.limit;\r\n        let url = path.join(folder_item, CfgMgr.Getitem(this.costCfg.CostID[0]).Icon, \"spriteFrame\");\r\n        this.costIcon.spriteFrame = await ResMgr.LoadResAbSub(url, SpriteFrame);\r\n        this.costLab.string = (this.costCfg.CostNumber[0] * this.buyCount).toString();\r\n        this.numLab.string = \"×\" + this.buyCount.toString();\r\n    }\r\n\r\n    protected onDel() {\r\n        this.buyCount = Math.max(1, this.buyCount - 1);\r\n        this.updateProgress();\r\n    }\r\n    protected onAdd() {\r\n        this.buyCount = Math.max(1, this.buyCount + 1);\r\n        this.updateProgress();\r\n    }\r\n    protected onBuy() {\r\n        if (!this.selectShop) {\r\n            Tips.Show(\"请选择需要购买的商品\");\r\n            return;\r\n        }\r\n        let buy_item = new Req[\"shop.protocol.buyitem\"]();\r\n        buy_item.buyCount = this.buyCount;\r\n        buy_item.buyId = this.costCfg.Id;\r\n        buy_item.shopIndexId = this.selectShop.shopIndexId;\r\n        Session.Send(Route[\"shop.protocol.buyitem\"], buy_item);\r\n    }\r\n}"]}