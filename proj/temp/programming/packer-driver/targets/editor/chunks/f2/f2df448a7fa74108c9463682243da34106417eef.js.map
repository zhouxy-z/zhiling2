{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/fight/opOutput/Out_NewRound.ts"],"names":["Out_NewRound","Battle_End_Round","Battle_PlayNewRoundEffect","Battle_UpdateTerrain","EventMgr","BattleBaseComp","battleDataMgr","FightData","isInitCardEnd","isPlayEffectEnd","start","setRoomData","isExit","currentRound","curRound","scene","FlushRound","round","roomData","roundMax","finalValue","emit","on","onRoundEffectPlayEnd","reset","off","onUpdate","dt","exit","playerData","isPlayerA","key","data","gamePlayData","players","terrainMax","playerId","FlushPlayerInfo","totalPower","areaIdx","cardData","terrain","FlushAreaCrads","getPlayerTerrainTotalPow","FlushAreaPower","setHandCard","handCards","curEnergy","roundEnergy","FlushEnergy","FlushTerrain","ownerPlayerId","terrains","cards","FlushHandCard"],"mappings":"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","sourcesContent":["import { Battle_End_Round, Battle_PlayNewRoundEffect, Battle_UpdateTerrain, EventMgr } from \"../../../manager/EventMgr\";\r\nimport proto from \"../../../net/Protocol\";\r\nimport { BattleBaseComp } from \"../../battle/BattleBaseComp\";\r\nimport { battleDataMgr } from \"../../battle/BattleDataMgr\";\r\nimport { FightData } from \"../FightData\";\r\n\r\n/**\r\n * 新回合\r\n */\r\nexport class Out_NewRound extends BattleBaseComp<proto.base.IBattleRoomOpOutput_NewRound> {\r\n    private isInitCardEnd: boolean = false;//是否初始化手牌完成\r\n    private isPlayEffectEnd: boolean = false;//是否播放回合开始动画结束\r\n    protected async start() {\r\n        await this.setRoomData();\r\n        if (this.isExit) return;\r\n        FightData.currentRound = battleDataMgr.curRound;\r\n        this.scene.FlushRound(this.round, battleDataMgr.roomData.roundMax.finalValue);\r\n        EventMgr.emit(Battle_PlayNewRoundEffect, this.round, battleDataMgr.roomData.roundMax.finalValue);\r\n        EventMgr.on(Battle_End_Round, this.onRoundEffectPlayEnd, this);\r\n    }\r\n\r\n    protected reset(): void {\r\n        this.isInitCardEnd = false;\r\n        this.isPlayEffectEnd = false;\r\n        EventMgr.off(Battle_End_Round, this.onRoundEffectPlayEnd, this);\r\n    }\r\n\r\n    protected onUpdate(dt: number): void {\r\n        if (!this.isInitCardEnd) return;\r\n        if (!this.isPlayEffectEnd) return;\r\n        //全部动作完成退出播放\r\n        this.exit();\r\n    }\r\n    private onRoundEffectPlayEnd(): void {\r\n        this.isPlayEffectEnd = true;\r\n    }\r\n    /**\r\n     * 初始化房间数据\r\n     */\r\n    private async setRoomData() {\r\n\r\n        // 刷新场景手牌和卡牌\r\n        let playerData: proto.base.IBattleRoomPlayerData;\r\n        let isPlayerA: boolean;\r\n        for (let key in this.data.gamePlayData.players) {\r\n            playerData = this.data.gamePlayData.players[key];\r\n\r\n            let terrainMax = battleDataMgr.roomData.terrainMax;\r\n            isPlayerA = battleDataMgr.isPlayerA(playerData.playerId);\r\n            this.scene.FlushPlayerInfo(isPlayerA, playerData);\r\n            let totalPower: number;\r\n            for (let areaIdx = 0; areaIdx < terrainMax; areaIdx++) {\r\n                let cardData: proto.base.IBattleRoomTerrainPlayerData = playerData.terrain[areaIdx]\r\n                await this.scene.FlushAreaCrads(isPlayerA, areaIdx, cardData);\r\n                if (this.isExit) return;\r\n                totalPower = battleDataMgr.getPlayerTerrainTotalPow(playerData.playerId, areaIdx);\r\n                this.scene.FlushAreaPower(isPlayerA, areaIdx, totalPower);\r\n            }\r\n\r\n            if (isPlayerA) {\r\n                await this.setHandCard(playerData.handCards);\r\n                if (this.isExit) return;\r\n                let curEnergy: number = playerData.roundEnergy[this.round - 1]?.finalValue;\r\n                this.scene.FlushEnergy(curEnergy);\r\n            }\r\n        }\r\n\r\n        // 初始场景区域\r\n        await this.scene.FlushTerrain(true, this.data.gamePlayData, this.ownerPlayerId);\r\n        if (this.isExit) return;\r\n        EventMgr.emit(Battle_UpdateTerrain, this.data.gamePlayData.terrains, this.data.gamePlayData);\r\n    }\r\n\r\n    /**\r\n     * 设置手卡数据\r\n     */\r\n    private async setHandCard(cards: proto.base.IBattleRoomCardData[]) {\r\n        await this.scene.FlushHandCard(cards);\r\n        if (this.isExit) return;\r\n        this.isInitCardEnd = true;\r\n    }\r\n\r\n}"]}