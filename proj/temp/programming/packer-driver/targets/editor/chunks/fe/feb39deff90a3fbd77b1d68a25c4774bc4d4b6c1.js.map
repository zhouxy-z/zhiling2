{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/fight/opOutput/Out_AddCardToTerrain.ts"],"names":["Out_AddCardToTerrain","proto","Second","BattleBaseComp","battleDataMgr","actionEnd","start","isPlayerA","ownerPlayerId","fromIsPlayerA","data","fromPlayerId","toIsPlayerA","card","playerId","cardLocation","getPlayerAreaEmptyCardLocation","terrainInstId","scene","CardBackToArea","areaIdx","cardIdx","isExit","formCard","getPlayerCard","instId","fromLocation","base","BattleRoomCardLocation","Terrain","fromCardPower","getPlayerCardPower","fromTerrainData","getPlayerTerrainFormIdx","area","offsetPower","cardMul","finalValue","fromTotalPower","getPlayerTerrainTotalPow","FlushAreaPower","toTerrainData","getPlayerTerrainFormId","toTotalPower","addCardPower","power","exit","onUpdate","dt","reset"],"mappings":"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","sourcesContent":["import proto from \"../../../net/Protocol\";\r\nimport { Second } from \"../../../utils/Utils\";\r\nimport { BattleBaseComp } from \"../../battle/BattleBaseComp\";\r\nimport { battleDataMgr } from \"../../battle/BattleDataMgr\";\r\nimport { CardLocation } from \"../../player/PlayerStruct\";\r\n/**\r\n * 添加卡牌到场地区域（都是已揭示的牌）\r\n */\r\nexport class Out_AddCardToTerrain extends BattleBaseComp<proto.base.IBattleRoomOpOutput_AddCardToTerrain> {\r\n    private actionEnd: boolean = false;\r\n    protected async start(): Promise<void> {\r\n        let isPlayerA = battleDataMgr.isPlayerA(this.ownerPlayerId);\r\n        let fromIsPlayerA: boolean = battleDataMgr.isPlayerA(this.data.fromPlayerId);\r\n        let toIsPlayerA: boolean = battleDataMgr.isPlayerA(this.data.card.playerId);\r\n        let cardLocation: CardLocation = battleDataMgr.getPlayerAreaEmptyCardLocation(this.data.card.playerId, this.data.terrainInstId);\r\n        \r\n        await this.scene.CardBackToArea(isPlayerA, fromIsPlayerA, toIsPlayerA, cardLocation.areaIdx, cardLocation.cardIdx, this.data);\r\n        if (this.isExit) return;\r\n        let formCard: proto.base.IBattleRoomCardData;\r\n        //来源卡可能是来自系统\r\n        if (this.data.fromPlayerId != \"\") formCard  = battleDataMgr.getPlayerCard(this.data.fromPlayerId, this.data.card.instId);\r\n        //此卡如果来自场地则减掉此卡的战力\r\n        if (formCard && this.data.fromLocation && this.data.fromLocation == proto.base.BattleRoomCardLocation.Terrain) {\r\n            //减掉移动来源的卡牌战力\r\n            let fromCardPower: number = battleDataMgr.getPlayerCardPower(this.data.fromPlayerId, this.data.card.instId);\r\n            let fromTerrainData: proto.base.IBattleRoomTerrainPlayerData = battleDataMgr.getPlayerTerrainFormIdx(this.data.fromPlayerId, formCard.area);\r\n            let offsetPower: number = fromTerrainData.cardMul.finalValue * fromCardPower;\r\n            let fromTotalPower = battleDataMgr.getPlayerTerrainTotalPow(this.data.fromPlayerId, formCard.area);\r\n            this.scene.FlushAreaPower(battleDataMgr.isPlayerA(this.data.fromPlayerId), formCard.area, fromTotalPower - offsetPower);\r\n        }\r\n    \r\n        //增加目的区域的战力\r\n        let toTerrainData: proto.base.IBattleRoomTerrainPlayerData = battleDataMgr.getPlayerTerrainFormId(this.data.card.playerId, this.data.terrainInstId);\r\n        let toTotalPower: number = battleDataMgr.getPlayerTerrainTotalPow(this.data.card.playerId, cardLocation.areaIdx);\r\n        let addCardPower: number = this.data.card.power ? this.data.card.power.finalValue * toTerrainData.cardMul.finalValue : 0;\r\n        this.scene.FlushAreaPower(battleDataMgr.isPlayerA(this.data.card.playerId), cardLocation.areaIdx, toTotalPower + addCardPower);\r\n\r\n\r\n        await Second(0.5);\r\n        if (this.isExit) return;\r\n        this.exit();\r\n    }\r\n\r\n    protected onUpdate(dt: number): void {\r\n        if (!this.actionEnd) return;\r\n        this.exit();\r\n    }\r\n\r\n    protected reset(): void {\r\n        this.actionEnd = false;\r\n    }\r\n}"]}