{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/cards/Card%20copy.ts"],"names":["Card","Component","Label","path","sp","Sprite","SpriteFrame","CfgMgr","card_quality","ResMgr","Utils","EventMgr","Evt_Card_Chage","Evt_Item_Change","PlayerData","frame","nameframe","nameLab","costLab","body_card","powerLab","select","doneNode","add","cardMask","cardNode","upEffect","tradeCd","effectFrame","isShowEffect","data","addCallBack","$loadSub","complete","hasLoad","onLoad","node","getChildByPath","getComponent","Skeleton","getChildByName","active","loadSub","thisObj","Promise","resolve","reject","onEnable","on","onUpdateCard","onItemChange","onDisable","off","cardData","id","SetData","updateUpgradeState","std","GetCard","cardId","string","Cost","Power","CardName","skeletonData","LoadResAbSub","join","CardBody","SkeletonData","setAnimation","clearAnimation","quality","toString","spriteFrame","isCanUpgrade","CheckCardIsCanUpgrade","setSelect","is_select","getSelectState","getData","setGray","is_gray","SetNodeGray","setCardMask","bool","setCardTradeCd","setCardEffectState","setShowAdd","callBack"],"mappings":"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","sourcesContent":["import { Component, Input, Label, Node, path, sp, Sprite, SpriteFrame } from \"cc\";\r\nimport { CfgMgr } from \"../../manager/CfgMgr\";\r\nimport { card_quality, ResMgr } from \"../../manager/ResMgr\";\r\nimport { Second, Utils } from \"../../utils/Utils\";\r\nimport proto from \"../../net/Protocol\";\r\nimport { EventMgr, Evt_Card_Chage, Evt_Item_Change } from \"../../manager/EventMgr\";\r\nimport { PlayerData } from \"../player/PlayerData\";\r\n\r\nexport class Card extends Component {\r\n    private frame: sp.Skeleton;\r\n    private nameframe: Sprite;\r\n    private nameLab: Label;\r\n    private costLab: Label;\r\n    private body_card: sp.Skeleton;\r\n    private powerLab: Label;\r\n    private select: Node;\r\n    private doneNode: Node;\r\n    private add: Node;\r\n    private cardMask: Node;\r\n    private cardNode: Node;\r\n    private upEffect: Node;\r\n    private tradeCd: Node;\r\n    private effectFrame: sp.Skeleton;\r\n\r\n    private isShowEffect:boolean = true;\r\n\r\n    private data:proto.base.IBattleCard\r\n    private addCallBack:Function;\r\n    protected $loadSub: Promise<any>;\r\n    protected complete: Function;\r\n    protected hasLoad = false;\r\n\r\n\r\n    protected onLoad(): void {\r\n        this.frame = this.node.getChildByPath(\"cardNode/frame\").getComponent(sp.Skeleton);\r\n        this.costLab = this.node.getChildByPath(\"cardNode/cost/label\").getComponent(Label);\r\n        this.powerLab = this.node.getChildByPath(\"cardNode/power/label\").getComponent(Label);\r\n        this.nameframe = this.node.getChildByPath(\"cardNode/nameframe\").getComponent(Sprite);\r\n        this.nameLab = this.node.getChildByPath(\"cardNode/nameframe/name\").getComponent(Label);\r\n        this.body_card = this.node.getChildByPath(\"cardNode/body_card\").getComponent(sp.Skeleton);\r\n        this.select = this.node.getChildByPath(\"cardNode/select\");\r\n        this.effectFrame = this.node.getChildByPath(\"cardNode/effectFrame\").getComponent(sp.Skeleton);\r\n        this.doneNode = this.node.getChildByName(\"doneNode\");\r\n        this.add = this.node.getChildByName(\"add\");\r\n        this.cardMask = this.node.getChildByName(\"cardMask\");\r\n        this.cardNode = this.node.getChildByName(\"cardNode\");\r\n        this.upEffect = this.node.getChildByName(\"upEffect\");\r\n        this.tradeCd = this.node.getChildByName(\"tradeCd\");\r\n        this.cardMask.active = false;\r\n        this.upEffect.active = false;\r\n        this.tradeCd.active = false;\r\n        this.add.active = false;\r\n        this.hasLoad = true;\r\n        this.complete?.();\r\n    }\r\n\r\n    protected get loadSub() {\r\n        if (this.$loadSub) return this.$loadSub;\r\n        let thisObj = this;\r\n        this.$loadSub = new Promise((resolve, reject) => {\r\n            thisObj.complete = resolve;\r\n        });\r\n        return this.$loadSub;\r\n    }\r\n    protected onEnable(): void {\r\n        EventMgr.on(Evt_Card_Chage, this.onUpdateCard, this);\r\n        EventMgr.on(Evt_Item_Change, this.onItemChange, this);\r\n    }\r\n\r\n    protected onDisable(): void {\r\n        EventMgr.off(Evt_Card_Chage, this.onUpdateCard, this);\r\n        EventMgr.off(Evt_Item_Change, this.onItemChange, this);\r\n    }\r\n\r\n    private onUpdateCard(cardData: proto.base.BattleCard): void {\r\n        if (this.data && this.data.id == cardData.id) {\r\n            this.SetData(cardData);\r\n        }\r\n    }\r\n\r\n    private onItemChange(): void {\r\n        this.updateUpgradeState();\r\n    }\r\n\r\n    /**\r\n     * 设置角色数据\r\n     * @param data \r\n     */\r\n    async SetData(data: proto.base.IBattleCard) {\r\n        if (!this.hasLoad) await this.loadSub;\r\n    \r\n        if(data == null){\r\n            this.doneNode.active = true;\r\n            this.cardNode.active = false;\r\n            this.data = null;\r\n            this.upEffect.active = false;\r\n            return;\r\n        }else{\r\n            this.doneNode.active = false;\r\n            this.cardNode.active = true;\r\n        }\r\n        this.body_card.node.active = true;    \r\n        this.data = data;\r\n        let std = CfgMgr.GetCard(data.cardId)\r\n        this.costLab.string = std.Cost + \"\";\r\n        this.powerLab.string = std.Power + \"\";\r\n        this.nameLab.string = std.CardName;\r\n\r\n        this.body_card.skeletonData = await ResMgr.LoadResAbSub(path.join(\"spine\",  std.CardBody, std.CardBody), sp.SkeletonData);\r\n        this.body_card.setAnimation(0, \"Idle\", true);\r\n        this.frame.clearAnimation();\r\n        this.frame.skeletonData = await ResMgr.LoadResAbSub(path.join(\"spine\",  \"cardbg_000\" + this.data.quality, \"cardbg_000\" + this.data.quality), sp.SkeletonData); \r\n        this.frame.setAnimation(0, \"Idle\", true);\r\n        \r\n        this.effectFrame.clearAnimation();\r\n        this.effectFrame.setAnimation(0, data.quality.toString(), true);\r\n        this.nameframe.spriteFrame = await ResMgr.LoadResAbSub(path.join(card_quality,  \"nameframe_\" + data.quality, \"spriteFrame\"), SpriteFrame);\r\n\r\n        this.updateUpgradeState();\r\n    }\r\n\r\n    private updateUpgradeState(): void {\r\n        let isCanUpgrade: boolean = PlayerData.CheckCardIsCanUpgrade(this.data && this.data.id);\r\n        this.upEffect.active = isCanUpgrade && this.isShowEffect;\r\n    }\r\n\r\n    async setSelect(is_select: boolean){\r\n        if (!this.hasLoad) await this.loadSub;\r\n        this.select.active = is_select;\r\n    }\r\n\r\n    getSelectState(){\r\n        return this.select.active;\r\n    }\r\n\r\n    getData(){\r\n        return this.data;\r\n    }\r\n\r\n    setGray(is_gray){\r\n        Utils.SetNodeGray(this.node, is_gray)\r\n    }\r\n\r\n    setCardMask(bool: boolean): void {\r\n        this.cardMask.active = bool;\r\n    }\r\n\r\n    async setCardTradeCd(bool: boolean) {\r\n        if (!this.hasLoad) await this.loadSub;\r\n        this.tradeCd.active = bool;\r\n    }\r\n\r\n    setCardEffectState(bool: boolean) {\r\n       this.isShowEffect = bool;\r\n    }\r\n\r\n    async setShowAdd(bool: boolean, callBack?:Function){\r\n        if (!this.hasLoad) await this.loadSub;\r\n        this.add.active = bool;\r\n    }\r\n}"]}