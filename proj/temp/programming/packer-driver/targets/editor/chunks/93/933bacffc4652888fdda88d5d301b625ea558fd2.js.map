{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/mail/MailContent.ts"],"names":["MailContent","Component","Input","Label","Toggle","AutoScroller","Session","LocalStorage","DateUtils","PlayerData","Utils","Req","Route","BagItem","ItemUtil","Card","Goto","Tips","title","time","desc","scroller","getBtn","delBtn","empty","geted","mailInfo","time_differ","deleteTime","$loadSub","complete","hasLoad","loadSub","thisObj","Promise","resolve","reject","onLoad","node","getChildByName","getComponent","getChildByPath","SetHandle","UpdateBagItem","bind","on","EventType","TOUCH_END","onDel","onGet","data","mailId","id","Send","isAttachmentClaimed","Show","GetNumber","player","playerId","isopen","isSameDay","onDelMail","mailIds","itemNode","item","card","active","card_item","addComponent","SetData","setCardMask","bag_item","item_data","ChangeItem","setThing","scheduleOnce","enabled","flush","string","length","slice","formatDate","content","attachments","reward_data","getMailReward","UpdateDatas","children","forEach"],"mappings":"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","sourcesContent":["import { Component, Input, Label, Node, ScrollView, Toggle, UITransform } from \"cc\";\r\nimport { AutoScroller } from \"../../component/AutoScroller\";\r\nimport { Session } from \"../../net/Session\";\r\nimport LocalStorage from \"../../utils/LocalStorage\";\r\nimport { DateUtils } from \"../../utils/DateUtils\";\r\nimport { SPlayerMailData } from \"../player/PlayerStruct\";\r\nimport { PlayerData } from \"../player/PlayerData\";\r\nimport { Utils } from \"../../utils/Utils\";\r\nimport proto, { Req, Route } from \"../../net/Protocol\";\r\nimport { BagItem } from \"../bag/BagItem\";\r\nimport { ItemUtil } from \"../../utils/ItemUtils\";\r\nimport { Card } from \"../cards/Card\";\r\nimport { Goto } from \"../../DL\";\r\nimport { Tips } from \"../common/Tips\";\r\nexport class MailContent extends Component {\r\n\r\n    protected title: Label;\r\n    protected time: Label;\r\n    protected desc: Label;\r\n    protected scroller: AutoScroller;\r\n    protected getBtn: Node;\r\n    private delBtn:Node;\r\n    private empty:Node;\r\n    private geted:Node;\r\n\r\n\r\n    protected mailInfo: SPlayerMailData;\r\n    private time_differ:number;\r\n    private deleteTime:number;\r\n    protected $loadSub: Promise<any>;\r\n    protected complete: Function;\r\n    protected hasLoad = false;\r\n\r\n    protected get loadSub() {\r\n        if (this.$loadSub) return this.$loadSub;\r\n        let thisObj = this;\r\n        this.$loadSub = new Promise((resolve, reject) => {\r\n            thisObj.complete = resolve;\r\n        });\r\n        return this.$loadSub;\r\n    }\r\n\r\n    protected onLoad() {\r\n        this.hasLoad = true;\r\n        this.title = this.node.getChildByName(\"title\").getComponent(Label);\r\n        this.time = this.node.getChildByName(\"time\").getComponent(Label);\r\n        this.desc = this.node.getChildByPath(\"ScrollViewLab/view/content/desc\").getComponent(Label);\r\n        this.scroller = this.node.getChildByName(\"ScrollView\").getComponent(AutoScroller);\r\n        this.scroller.SetHandle(this.UpdateBagItem.bind(this));\r\n        this.empty = this.node.getChildByName(\"empty\");\r\n        this.getBtn = this.node.getChildByName(\"getBtn\");\r\n        this.delBtn = this.node.getChildByName(\"delBtn\")\r\n        this.delBtn.on(Input.EventType.TOUCH_END, this.onDel, this);\r\n        this.getBtn.on(Input.EventType.TOUCH_END, this.onGet, this);\r\n\r\n        this.geted = this.node.getChildByName(\"geted\")\r\n    }\r\n\r\n    /**获取附件 */\r\n    protected onGet() {\r\n        let data = new Req[\"mail.protocol.claimmailattachment\"]();\r\n        data.mailId = this.mailInfo.id;\r\n        Session.Send(Route[\"mail.protocol.claimmailattachment\"], data);\r\n    }\r\n\r\n    /**删除邮件 */\r\n    protected onDel() {\r\n        if (!this.mailInfo.isAttachmentClaimed) {\r\n           Tips.Show(\"请先提取附件\");\r\n        } else {\r\n            let time = LocalStorage.GetNumber(\"MailDeletePanel\" + PlayerData.player.playerId)\r\n            if (time) {\r\n                let isopen = DateUtils.isSameDay(time)\r\n                if (isopen) {\r\n                    this.onDelMail();\r\n                    return;\r\n                }\r\n            }\r\n            Goto(\"MailDeletePanel\",this.onDelMail.bind(this));\r\n        }\r\n    }\r\n\r\n    private onDelMail() {\r\n        let data = new Req[\"mail.protocol.deletemails\"]();\r\n        data.mailIds = [this.mailInfo.id]\r\n        Session.Send(Route[\"mail.protocol.deletemails\"], data);\r\n        // this.Hide();\r\n    }\r\n\r\n    /**\r\n     * 更新背包道具item\r\n     * @param item \r\n     * @param data \r\n     */\r\n    private UpdateBagItem(itemNode: Node, data: proto.base.IThing) {\r\n\r\n        let item = itemNode.getChildByName(\"item\");\r\n        let card = itemNode.getChildByName(\"Cards\");\r\n        item.active = false;\r\n        card.active = false;\r\n        if(data.card){\r\n            card.active = true;\r\n            let card_item = card.getComponent(Card)\r\n            if(!card_item) card_item = card.addComponent(Card)\r\n            card_item.SetData(data.card)\r\n            card_item.setCardMask(false)\r\n\r\n        }else{\r\n            item.active = true;\r\n            let bag_item = item.getComponent(BagItem)\r\n            if(!bag_item) bag_item = item.addComponent(BagItem)\r\n             let item_data:proto.base.IThing = ItemUtil.ChangeItem(data);\r\n             bag_item.setThing(item_data)\r\n             item.getChildByName(\"mask\").active = false;\r\n             this.scheduleOnce(() => {\r\n                 item.getComponent(Toggle).enabled = false;\r\n             })\r\n        }\r\n    }\r\n\r\n    public async flush(data: SPlayerMailData) {\r\n        if (!this.hasLoad) await this.loadSub;\r\n        this.empty.active = false;\r\n        if(!data){\r\n            this.empty.active = true;\r\n            return;\r\n        }\r\n        this.mailInfo = data;\r\n        this.title.string = data.title.length > 10 ? data.title.slice(0, 10) + \"...\" :  data.title\r\n        this.time.string = `收件时间：${Utils.formatDate(data.time * 1000, 'yyyy-MM-dd hh:mm:ss')}`;\r\n        this.desc.string = data.content;\r\n        if (data.attachments && data.attachments.length) {\r\n            let reward_data = PlayerData.getMailReward(data.attachments);\r\n            this.scroller.UpdateDatas(reward_data);\r\n            if (data.isAttachmentClaimed) {\r\n                this.getBtn.active = false;\r\n                this.delBtn.active = true;\r\n                this.geted.active = true;\r\n                this.scroller.node.getChildByPath(\"view/content\").children.forEach((node)=>{              \r\n                    node.getChildByPath(\"Cards/cardMask\").active = true;\r\n                    node.getChildByPath(\"item/mask\").active = true;           \r\n                })\r\n            } else {\r\n                this.getBtn.active = true;\r\n                this.delBtn.active = false;  \r\n                this.geted.active = false;\r\n            }\r\n        } else {\r\n            this.scroller.UpdateDatas([]);\r\n            this.getBtn.active = false;\r\n            this.delBtn.active = true;\r\n            this.geted.active = false;   \r\n        }\r\n    }\r\n\r\n}\r\n"]}