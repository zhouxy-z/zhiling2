{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/utils/Shake.ts"],"names":["Shake","game","math","GameSet","rate","tick","endTick","loop","power","initV","start","duration","totalTime","addTick","update","end","removeTick","mainCamera","node","setWorldPosition","dt","dx","randomRange","dy","dz","x","y","z","Start","instance","worldPosition","clone","PixelSize","End"],"mappings":";;;oGAGaA,K;;;;;;;;;;;;;;;AAHEC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,I,OAAAA,I;;AACZC,MAAAA,O,iBAAAA,O;;;;;;;;;uBAEIH,K,GAAN,MAAMA,KAAN,CAAY;AAAA;AAAA,eAGPI,IAHO,GAGQ,IAHR;AAAA,eAIPC,IAJO,GAIA,CAJA;AAAA,eAKPC,OALO,GAKG,CALH;AAAA,eAMPC,IANO,GAMA,CANA;AAAA,eAOPC,KAPO,GAOC,CAPD;AAAA,eAQPC,KARO;AAAA;;AAUfC,QAAAA,KAAK,CAACF,KAAD,EAAgBG,QAAhB,EAAkCP,IAAlC,EAAgD;AACjD,eAAKG,IAAL,GAAY,CAAZ;AACA,eAAKH,IAAL,GAAYA,IAAZ;AACA,eAAKI,KAAL,GAAaA,KAAb;AACA,eAAKH,IAAL,GAAYJ,IAAI,CAACW,SAAL,GAAiB,IAA7B;AACA,eAAKN,OAAL,GAAe,KAAKD,IAAL,GAAYM,QAA3B;AACA;AAAA;AAAA,kCAAQE,OAAR,CAAgB,KAAKC,MAArB,EAA6B,IAA7B;AACH;;AAEDC,QAAAA,GAAG,GAAG;AACF;AAAA;AAAA,kCAAQC,UAAR,CAAmB,KAAKF,MAAxB,EAAgC,IAAhC;AACA;AAAA;AAAA,kCAAQG,UAAR,CAAmBC,IAAnB,CAAwBC,gBAAxB,CAAyC,KAAKV,KAA9C;AACH;;AAEDK,QAAAA,MAAM,CAACM,EAAD,EAAa;AACf,cAAI,KAAKf,IAAL,GAAY,KAAKC,OAArB,EAA8B;AAC1B,iBAAKD,IAAL,IAAae,EAAb;AACA,iBAAKb,IAAL,IAAaa,EAAb;;AACA,gBAAI,KAAKb,IAAL,IAAa,KAAKH,IAAtB,EAA4B;AACxB,mBAAKG,IAAL,GAAY,CAAZ;AACA,kBAAIc,EAAE,GAAGnB,IAAI,CAACoB,WAAL,CAAiB,CAAC,KAAKd,KAAvB,EAA8B,KAAKA,KAAnC,CAAT;AACA,kBAAIe,EAAE,GAAGrB,IAAI,CAACoB,WAAL,CAAiB,CAAC,KAAKd,KAAvB,EAA8B,KAAKA,KAAnC,CAAT;AACA,kBAAIgB,EAAE,GAAGtB,IAAI,CAACoB,WAAL,CAAiB,CAAC,KAAKd,KAAvB,EAA8B,KAAKA,KAAnC,CAAT;AACA;AAAA;AAAA,sCAAQS,UAAR,CAAmBC,IAAnB,CAAwBC,gBAAxB,CAAyC,KAAKV,KAAL,CAAWgB,CAAX,GAAeJ,EAAxD,EAA4D,KAAKZ,KAAL,CAAWiB,CAAX,GAAeH,EAA3E,EAA+E,KAAKd,KAAL,CAAWkB,CAAX,GAAeH,EAA9F,EALwB,CAMxB;AACH;AACJ,WAXD,MAWO;AACH,iBAAKT,GAAL;AACH;AACJ;AAED;AACJ;AACA;AACA;;;AACgB,eAALa,KAAK,CAACpB,KAAD,EAAgBG,QAAhB,EAAkCP,IAAY,GAAG,IAAjD,EAAuD;AAC/D,cAAI,CAAC,KAAKyB,QAAV,EAAoB;AAChB,iBAAKA,QAAL,GAAgB,IAAI7B,KAAJ,EAAhB;AACA,iBAAK6B,QAAL,CAAcpB,KAAd,GAAsB;AAAA;AAAA,oCAAQQ,UAAR,CAAmBC,IAAnB,CAAwBY,aAAxB,CAAsCC,KAAtC,EAAtB;AACH;;AACD,eAAKF,QAAL,CAAcnB,KAAd,CAAoBF,KAAK,GAAG;AAAA;AAAA,kCAAQwB,SAApC,EAA+CrB,QAA/C,EAAyDP,IAAzD;AACH;AAED;AACJ;AACA;AACA;;;AACc,eAAH6B,GAAG,GAAG;AACT,cAAI,CAAC,KAAKJ,QAAV,EAAoB;AACpB,eAAKA,QAAL,CAAcd,GAAd;AACH;;AA5Dc,O;;AAANf,MAAAA,K,CAEM6B,Q","sourcesContent":["import { Vec3, game, math } from \"cc\";\r\nimport { GameSet } from \"../manager/GameSet\";\r\n\r\nexport class Shake {\r\n\r\n    private static instance: Shake;\r\n    private rate: number = 0.02;\r\n    private tick = 0;\r\n    private endTick = 0;\r\n    private loop = 0;\r\n    private power = 0;\r\n    private initV: Vec3;\r\n\r\n    start(power: number, duration: number, rate: number) {\r\n        this.loop = 0;\r\n        this.rate = rate;\r\n        this.power = power;\r\n        this.tick = game.totalTime / 1000;\r\n        this.endTick = this.tick + duration;\r\n        GameSet.addTick(this.update, this);\r\n    }\r\n\r\n    end() {\r\n        GameSet.removeTick(this.update, this);\r\n        GameSet.mainCamera.node.setWorldPosition(this.initV);\r\n    }\r\n\r\n    update(dt: number) {\r\n        if (this.tick < this.endTick) {\r\n            this.tick += dt;\r\n            this.loop += dt;\r\n            if (this.loop >= this.rate) {\r\n                this.loop = 0;\r\n                let dx = math.randomRange(-this.power, this.power);\r\n                let dy = math.randomRange(-this.power, this.power);\r\n                let dz = math.randomRange(-this.power, this.power);\r\n                GameSet.mainCamera.node.setWorldPosition(this.initV.x + dx, this.initV.y + dy, this.initV.z + dz);\r\n                // console.log(\"shake\", GameSet.mainCamera.node.worldPosition.toString());\r\n            }\r\n        } else {\r\n            this.end();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 开始\r\n     * @param power \r\n     */\r\n    static Start(power: number, duration: number, rate: number = 0.02) {\r\n        if (!this.instance) {\r\n            this.instance = new Shake();\r\n            this.instance.initV = GameSet.mainCamera.node.worldPosition.clone();\r\n        }\r\n        this.instance.start(power * GameSet.PixelSize, duration, rate);\r\n    }\r\n\r\n    /**\r\n     * 停止\r\n     * @returns \r\n     */\r\n    static End() {\r\n        if (!this.instance) return;\r\n        this.instance.end();\r\n    }\r\n}"]}