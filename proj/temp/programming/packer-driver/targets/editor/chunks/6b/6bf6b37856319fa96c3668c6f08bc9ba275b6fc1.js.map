{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/fight/opOutput/Out_AddCard.ts"],"names":["Out_AddCard","proto","BattleBaseComp","battleDataMgr","start","scene","AddCard","isPlayerA","data","card","playerId","isExit","formCard","sourcePlayerId","getPlayerCard","instId","sourceLocation","base","BattleRoomCardLocation","Terrain","isMove","fromCardPower","getPlayerCardPower","fromTerrainData","getPlayerTerrainFormIdx","area","offsetPower","cardMul","finalValue","fromTotalPower","getPlayerTerrainTotalPow","FlushAreaPower","location","toTerrainData","toTotalPower","addCardPower","power","exit","reset"],"mappings":"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","sourcesContent":["\r\nimport proto from \"../../../net/Protocol\";\r\nimport { BattleBaseComp } from \"../../battle/BattleBaseComp\";\r\nimport { battleDataMgr } from \"../../battle/BattleDataMgr\";\r\n\r\n/**\r\n * 从场上数据选择来源卡牌数据\r\n */\r\nexport class Out_AddCard extends BattleBaseComp<proto.base.IBattleRoomOpOutput_AddCard> {\r\n    protected async start(): Promise<void> {\r\n        await this.scene.AddCard(battleDataMgr.isPlayerA(this.data.card.playerId), this.data);\r\n        if (this.isExit) return;\r\n        let formCard: proto.base.IBattleRoomCardData;\r\n        //来源卡可能是来自系统\r\n        if (this.data.sourcePlayerId != \"\") formCard  = battleDataMgr.getPlayerCard(this.data.sourcePlayerId, this.data.card.instId);\r\n        //此卡如果来自场地则减掉此卡的战力\r\n        if (formCard && this.data.sourceLocation && this.data.sourceLocation == proto.base.BattleRoomCardLocation.Terrain) {\r\n            if (this.data.isMove) {\r\n                //减掉移动来源的卡牌战力\r\n                let fromCardPower: number = battleDataMgr.getPlayerCardPower(this.data.sourcePlayerId, this.data.card.instId);\r\n                let fromTerrainData: proto.base.IBattleRoomTerrainPlayerData = battleDataMgr.getPlayerTerrainFormIdx(this.data.sourcePlayerId, formCard.area);\r\n                let offsetPower: number = fromTerrainData.cardMul.finalValue * fromCardPower;\r\n                let fromTotalPower = battleDataMgr.getPlayerTerrainTotalPow(this.data.sourcePlayerId, formCard.area);\r\n                this.scene.FlushAreaPower(battleDataMgr.isPlayerA(this.data.sourcePlayerId), formCard.area, fromTotalPower - offsetPower);\r\n            }\r\n            \r\n        }\r\n        if (this.data.card.location == proto.base.BattleRoomCardLocation.Terrain) {\r\n            //增加目的区域的战力\r\n            let toTerrainData: proto.base.IBattleRoomTerrainPlayerData = battleDataMgr.getPlayerTerrainFormIdx(this.data.card.playerId, this.data.card.area);\r\n            let toTotalPower: number = battleDataMgr.getPlayerTerrainTotalPow(this.data.card.playerId, this.data.card.area);\r\n            let addCardPower: number = this.data.card.power ? this.data.card.power.finalValue * toTerrainData.cardMul.finalValue : 0;\r\n            this.scene.FlushAreaPower(battleDataMgr.isPlayerA(this.data.card.playerId), this.data.card.area, toTotalPower + addCardPower);\r\n        }\r\n    \r\n        \r\n\r\n\r\n        this.exit();\r\n    }\r\n\r\n    protected reset(): void {\r\n        \r\n    }   \r\n}"]}