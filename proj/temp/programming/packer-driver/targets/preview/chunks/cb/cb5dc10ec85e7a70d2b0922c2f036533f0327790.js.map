{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/mail/MailContentPanel.ts"],"names":["MailContentPanel","Input","Label","Toggle","AutoScroller","Session","LocalStorage","DateUtils","MailDeletePanel","BagItem1","Panel","Tips","PlayerData","Req","Route","Utils","prefab","title","time","sender","desc","scroller","getBtn","mailInfo","time_lock","is_begin","time_differ","deleteTime","onLoad","CloseBy","find","SetHandle","UpdateBagItem","bind","on","EventType","TOUCH_END","onDel","onGet","data","mailId","id","Send","isAttachmentClaimed","Show","GetNumber","player","playerId","isopen","isSameDay","onDelMail","mailIds","Hide","onShow","item","scheduleOnce","getComponent","enabled","setIsShowTips","flush","string","formatDate","content","senderPlayerId","attachments","length","reward_data","getMailReward","UpdateDatas","active","update","dt","onHide"],"mappings":"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","sourcesContent":["import { Input, Label, Node, ScrollView, Toggle, UITransform } from \"cc\";\r\nimport { AutoScroller } from \"../../component/AutoScroller\";\r\nimport { Session } from \"../../net/Session\";\r\nimport LocalStorage from \"../../utils/LocalStorage\";\r\nimport { DateUtils } from \"../../utils/DateUtils\";\r\nimport { MailDeletePanel } from \"./MailDeletePanel\";\r\nimport { BagItem1 } from \"../bag/BagItem1\";\r\nimport { SPlayerMailData, SThing } from \"../player/PlayerStruct\";\r\nimport { Panel } from \"../../manager/GameRoot\";\r\nimport { Tips } from \"../common/Tips\";\r\nimport { PlayerData } from \"../player/PlayerData\";\r\nimport { CfgMgr } from \"../../manager/CfgMgr\";\r\nimport { Req, Route } from \"../../net/Protocol\";\r\nimport { Utils } from \"../../utils/Utils\";\r\nexport class MailContentPanel extends Panel {\r\n    protected prefab: string = \"prefabs/mail/MailContentPanel\";\r\n\r\n    protected title: Label;\r\n    protected time: Label;\r\n    protected sender: Label;\r\n    protected desc: Label;\r\n    protected scroller: AutoScroller;\r\n    protected getBtn: Node;\r\n    protected mailInfo: SPlayerMailData;\r\n    private time_lock: number;\r\n    private is_begin: boolean = false;\r\n    private time_differ: number;\r\n    private deleteTime: number;\r\n\r\n\r\n    protected onLoad() {\r\n        this.CloseBy(\"mask\");\r\n        this.CloseBy(\"closeBtn\");\r\n        this.title = this.find(\"title\", Label);\r\n        this.time = this.find(\"time\", Label);\r\n        this.sender = this.find(\"sender\", Label);\r\n        this.desc = this.find(\"ScrollViewLab/view/content/desc\", Label);\r\n        this.scroller = this.find(\"ScrollView\", AutoScroller);\r\n        this.scroller.SetHandle(this.UpdateBagItem.bind(this));\r\n\r\n        this.getBtn = this.find(\"getBtn\");\r\n        this.find(\"delBtn\").on(Input.EventType.TOUCH_END, this.onDel, this);\r\n        this.getBtn.on(Input.EventType.TOUCH_END, this.onGet, this);\r\n    }\r\n\r\n    /**获取附件 */\r\n    protected onGet() {\r\n        let data = new Req[\"mail.protocol.claimmailattachment\"]();\r\n        data.mailId = this.mailInfo.id;\r\n        Session.Send(Route[\"mail.protocol.claimmailattachment\"], data);\r\n    }\r\n\r\n    /**删除邮件 */\r\n    protected onDel() {\r\n        if (!this.mailInfo.isAttachmentClaimed) {\r\n            Tips.Show(\"请先提取附件\");\r\n        } else {\r\n            let time = LocalStorage.GetNumber(\"MailDeletePanel\" + PlayerData.player.playerId)\r\n            if (time) {\r\n                let isopen = DateUtils.isSameDay(time)\r\n                if (isopen) {\r\n                    this.onDelMail();\r\n                    return;\r\n                }\r\n            }\r\n            MailDeletePanel.Show(this.onDelMail.bind(this));\r\n        }\r\n    }\r\n\r\n    private onDelMail() {\r\n        let data = new Req[\"mail.protocol.deletemails\"]();\r\n        data.mailIds = [this.mailInfo.id]\r\n        Session.Send(Route[\"mail.protocol.deletemails\"], data);\r\n        this.Hide();\r\n    }\r\n\r\n    protected onShow(): void {\r\n\r\n    }\r\n    /**\r\n     * 更新背包道具item\r\n     * @param item \r\n     * @param data \r\n     */\r\n    private async UpdateBagItem(item: Node, data: SThing) {\r\n        await BagItem1.UpdateBagItem(item, data);\r\n        this.scheduleOnce(() => {\r\n            item.getComponent(Toggle).enabled = false;\r\n        })\r\n        item.getComponent(BagItem1).setIsShowTips(true);\r\n\r\n    }\r\n\r\n    public flush(data: SPlayerMailData): void {\r\n        this.mailInfo = data;\r\n        this.title.string = this.mailInfo.title\r\n        this.time.string = `收件时间：${Utils.formatDate(data.time * 1000, 'yyyy-MM-dd hh:mm:ss')}`;\r\n        this.desc.string = data.content;\r\n        this.sender.string = `发件人：${data.senderPlayerId || `系统邮件`}`;\r\n        // this.time_differ = PlayerData.GetServerTime() - data.time;\r\n        if (data.attachments && data.attachments.length) {\r\n            let reward_data = PlayerData.getMailReward(data.attachments);\r\n            this.scroller.UpdateDatas(reward_data);\r\n            if (data.isAttachmentClaimed) {\r\n                this.getBtn.active = false;\r\n                // this.deleteTime = CfgMgr.GetCommon(StdCommonType.Mail).DeleteTime2\r\n            } else {\r\n                this.getBtn.active = true;\r\n                // this.deleteTime = CfgMgr.GetCommon(StdCommonType.Mail).DeleteTime1\r\n            }\r\n        } else {\r\n            this.scroller.UpdateDatas([]);\r\n            this.getBtn.active = false;\r\n            // this.deleteTime = CfgMgr.GetCommon(StdCommonType.Mail).DeleteTime2\r\n        }\r\n\r\n        if (this.time_differ > this.deleteTime) {\r\n            this.is_begin = false;\r\n        } else {\r\n            this.is_begin = true;\r\n        }\r\n    }\r\n\r\n    protected update(dt: number): void {\r\n        // if(this.is_begin){\r\n        //     let time_differ = PlayerData.GetServerTime() - this.mailInfo.time\r\n        //     let seconds = this.deleteTime - time_differ + PlayerData.GetServerTime();\r\n        //     seconds = Math.floor(seconds)\r\n        //     if (seconds > 0) {\r\n        //         let time = PlayerData.countDown2(seconds);\r\n        //         if(time.d > 0){\r\n        //             this.delete_time.string = \"剩余\" + time.d + \"天\";\r\n        //             this.is_begin = false;\r\n        //         }else{\r\n        //             this.delete_time.string = \"剩余\" + time.h + \":\" + time.m + \":\" + time.s;\r\n        //             this.is_begin = true;\r\n        //         }\r\n        //     } else {\r\n        //         this.delete_time.string = \"\";\r\n        //         this.is_begin = false;\r\n        //     }\r\n        // }\r\n    }\r\n\r\n    protected onHide(...args: any[]): void {\r\n\r\n    }\r\n\r\n}\r\n"]}