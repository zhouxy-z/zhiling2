{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/fight/opOutput/Out_AddCardToTerrain.ts"],"names":["Out_AddCardToTerrain","proto","Second","BattleBaseComp","battleDataMgr","actionEnd","start","isPlayerA","ownerPlayerId","fromIsPlayerA","data","fromPlayerId","toIsPlayerA","card","playerId","cardLocation","getPlayerAreaEmptyCardLocation","terrainInstId","scene","CardBackToArea","areaIdx","cardIdx","isExit","formCard","getPlayerCard","instId","fromLocation","base","BattleRoomCardLocation","Terrain","fromCardPower","getPlayerCardPower","fromTerrainData","getPlayerTerrainFormIdx","area","offsetPower","cardMul","finalValue","fromTotalPower","getPlayerTerrainTotalPow","FlushAreaPower","toTerrainData","getPlayerTerrainFormId","toTotalPower","addCardPower","power","exit","onUpdate","dt","reset"],"mappings":"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","sourcesContent":["import proto from \"../../../net/Protocol\";\r\nimport { Second } from \"../../../utils/Utils\";\r\nimport { BattleBaseComp } from \"../../battle/BattleBaseComp\";\r\nimport { battleDataMgr } from \"../../battle/BattleDataMgr\";\r\nimport { CardLocation } from \"../../player/PlayerStruct\";\r\n/**\r\n * 添加卡牌到场地区域（都是已揭示的牌）\r\n */\r\nexport class Out_AddCardToTerrain extends BattleBaseComp<proto.base.IBattleRoomOpOutput_AddCardToTerrain> {\r\n    private actionEnd: boolean = false;\r\n    protected async start(): Promise<void> {\r\n        let isPlayerA = battleDataMgr.isPlayerA(this.ownerPlayerId);\r\n        let fromIsPlayerA: boolean = battleDataMgr.isPlayerA(this.data.fromPlayerId);\r\n        let toIsPlayerA: boolean = battleDataMgr.isPlayerA(this.data.card.playerId);\r\n        let cardLocation: CardLocation = battleDataMgr.getPlayerAreaEmptyCardLocation(this.data.card.playerId, this.data.terrainInstId);\r\n        \r\n        await this.scene.CardBackToArea(isPlayerA, fromIsPlayerA, toIsPlayerA, cardLocation.areaIdx, cardLocation.cardIdx, this.data);\r\n        if (this.isExit) return;\r\n        let formCard: proto.base.IBattleRoomCardData;\r\n        //来源卡可能是来自系统\r\n        if (this.data.fromPlayerId != \"\") formCard  = battleDataMgr.getPlayerCard(this.data.fromPlayerId, this.data.card.instId);\r\n        //此卡如果来自场地则减掉此卡的战力\r\n        if (formCard && this.data.fromLocation && this.data.fromLocation == proto.base.BattleRoomCardLocation.Terrain) {\r\n            //减掉移动来源的卡牌战力\r\n            let fromCardPower: number = battleDataMgr.getPlayerCardPower(this.data.fromPlayerId, this.data.card.instId);\r\n            let fromTerrainData: proto.base.IBattleRoomTerrainPlayerData = battleDataMgr.getPlayerTerrainFormIdx(this.data.fromPlayerId, formCard.area);\r\n            let offsetPower: number = fromTerrainData.cardMul.finalValue * fromCardPower;\r\n            let fromTotalPower = battleDataMgr.getPlayerTerrainTotalPow(this.data.fromPlayerId, formCard.area);\r\n            this.scene.FlushAreaPower(battleDataMgr.isPlayerA(this.data.fromPlayerId), formCard.area, fromTotalPower - offsetPower);\r\n        }\r\n    \r\n        //增加目的区域的战力\r\n        let toTerrainData: proto.base.IBattleRoomTerrainPlayerData = battleDataMgr.getPlayerTerrainFormId(this.data.card.playerId, this.data.terrainInstId);\r\n        let toTotalPower: number = battleDataMgr.getPlayerTerrainTotalPow(this.data.card.playerId, cardLocation.areaIdx);\r\n        let addCardPower: number = this.data.card.power ? this.data.card.power.finalValue * toTerrainData.cardMul.finalValue : 0;\r\n        this.scene.FlushAreaPower(battleDataMgr.isPlayerA(this.data.card.playerId), cardLocation.areaIdx, toTotalPower + addCardPower);\r\n\r\n\r\n        await Second(0.5);\r\n        if (this.isExit) return;\r\n        this.exit();\r\n    }\r\n\r\n    protected onUpdate(dt: number): void {\r\n        if (!this.actionEnd) return;\r\n        this.exit();\r\n    }\r\n\r\n    protected reset(): void {\r\n        this.actionEnd = false;\r\n    }\r\n}"]}