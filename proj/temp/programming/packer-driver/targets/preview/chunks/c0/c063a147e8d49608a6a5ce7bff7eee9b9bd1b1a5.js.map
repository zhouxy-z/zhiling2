{"version":3,"sources":["file:///D:/plants_client/trunk/proj/assets/scripts/module/bag/BagPanel.ts"],"names":["BagPanel","Input","Label","Sprite","SpriteFrame","Toggle","instantiate","path","Panel","AutoScroller","PlayerData","CfgMgr","BagItem","ResMgr","folder_item","EventMgr","Evt_GetReward","Evt_Item_Change","Tips","Goto","prefab","infoView","itemShow","empty","scroller","navBtns","currentPage","selector","onLoad","CloseBy","find","SetHandle","updateItem","bind","node","on","onSelect","nav","children","forEach","item","index","push","getComponent","EventType","TOUCH_END","e","onPage","onUse","ontrade","onShow","flush","SetPage","onHide","page","$hasLoad","initSub","btn","isChecked","reflush","items","GetitemBySubType","i","length","HideBag","splice","UpdateDatas","active","SelectFirst","undefined","data","bagItem","addComponent","setThing","stdItem","Getitem","id","getChildByName","spriteFrame","LoadResAbSub","Quality","join","Icon","fetchs","Get","getChildByPath","string","ItemName","count","Remark","layout","len","Math","max","SkipGet","child","addChild","stdFetch","off","Win","Desc","goto","Button","indexOf","win","Show"],"mappings":"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","sourcesContent":["import { EventTouch, Input, Label, Node, Sprite, SpriteFrame, Toggle, instantiate, path } from \"cc\";\r\n\r\nimport { Panel } from \"../../manager/GameRoot\";\r\nimport { AutoScroller } from \"../../component/AutoScroller\";\r\nimport { PlayerData } from \"../player/PlayerData\";\r\nimport { CfgMgr, StdItem } from \"../../manager/CfgMgr\";\r\nimport { BagItem } from \"./BagItem\";\r\nimport { ResMgr, folder_item } from \"../../manager/ResMgr\";\r\nimport { EventMgr, Evt_GetReward, Evt_Item_Change } from \"../../manager/EventMgr\";\r\nimport { Tips } from \"../common/Tips\";\r\nimport { Goto } from \"../../DL\";\r\nimport proto from \"../../net/Protocol\";\r\n\r\nexport class BagPanel extends Panel {\r\n    protected prefab: string = \"prefabs/bag/BagPanel\";\r\n\r\n    protected infoView: Node;\r\n    protected itemShow: Node;\r\n    protected empty: Node;\r\n    protected scroller: AutoScroller;\r\n    protected navBtns: Toggle[] = [];\r\n    protected currentPage: number;\r\n    protected selector: StdItem;\r\n\r\n    protected async onLoad() {\r\n        this.CloseBy(\"backBtn\");\r\n        this.infoView = this.find(\"infoView\");\r\n        this.itemShow = this.find(\"itemShow\");\r\n        this.empty = this.find(\"empty\");\r\n        this.scroller = this.find(\"ScrollView\", AutoScroller);\r\n        this.scroller.SetHandle(this.updateItem.bind(this));\r\n        this.scroller.node.on('select', this.onSelect, this);\r\n\r\n        let nav = this.find(\"nav\");\r\n        nav.children.forEach((item, index) => {\r\n            this.navBtns.push(item.getComponent(Toggle));\r\n            item.on(Input.EventType.TOUCH_END, e => {\r\n                this.onPage(index);\r\n            }, this);\r\n        });\r\n\r\n        this.find(\"infoView/useBtn\").on(Input.EventType.TOUCH_END, this.onUse, this);\r\n        this.find(\"infoView/tradeBtn\").on(Input.EventType.TOUCH_END, this.ontrade, this);\r\n    }\r\n\r\n    protected onShow(): void {\r\n        EventMgr.on(Evt_Item_Change, this.flush, this);\r\n        EventMgr.on(Evt_GetReward, this.flush, this);\r\n    }\r\n\r\n    public flush(...args: any[]): void {\r\n        this.SetPage(this.currentPage || 0);\r\n    }\r\n\r\n    protected onHide(...args: any[]): void {\r\n\r\n    }\r\n\r\n    public async SetPage(page: number) {\r\n        if (!this.$hasLoad) await this.initSub;\r\n        let btn = this.navBtns[page];\r\n        if (btn) btn.isChecked = true;\r\n        this.onPage(page);\r\n    }\r\n    onPage(page: number) {\r\n        let reflush = this.currentPage != page;\r\n        this.currentPage = page;\r\n        let items = PlayerData.GetitemBySubType(page);\r\n        for (let i = items.length - 1; i >= 0; i--) {\r\n            if (items[i].item['std'].HideBag) {\r\n                items.splice(i, 1);\r\n            }\r\n        }\r\n        this.scroller.UpdateDatas(items);\r\n        if (items.length <= 0) {\r\n            this.empty.active = true;\r\n            this.infoView.active = this.itemShow.active = false;\r\n        } else {\r\n            this.empty.active = false;\r\n            this.infoView.active = this.itemShow.active = true;\r\n        }\r\n        if (reflush && items?.length) {\r\n            this.scroller.SelectFirst();\r\n            this.onSelect(undefined, undefined, items[0]);\r\n        }\r\n    }\r\n    protected updateItem(item: Node, data: any, index: number) {\r\n        let bagItem = item.getComponent(BagItem) || item.addComponent(BagItem);\r\n        bagItem.setThing(data);\r\n    }\r\n    protected async onSelect(index: number, item: Node, data: proto.base.IThing) {\r\n        this.empty.active = false;\r\n        this.infoView.active = this.itemShow.active = true;\r\n        let stdItem = CfgMgr.Getitem(data.item.id);\r\n        this.selector = stdItem;\r\n        this.itemShow.getChildByName(\"bg\").getComponent(Sprite).spriteFrame = await ResMgr.LoadResAbSub(\"sheets/bag/Quality_\" + stdItem.Quality + \"/spriteFrame\", SpriteFrame);\r\n        this.itemShow.getChildByName(\"icon\").getComponent(Sprite).spriteFrame = await ResMgr.LoadResAbSub(path.join(folder_item, stdItem.Icon, \"spriteFrame\"), SpriteFrame);\r\n\r\n        let fetchs = CfgMgr.Get(\"fetch\");\r\n        this.infoView.getChildByPath(\"nameLab\").getComponent(Label).string = stdItem.ItemName;\r\n        this.infoView.getChildByPath(\"numLab\").getComponent(Label).string = data.item.count;\r\n        this.infoView.getChildByPath(\"descLab\").getComponent(Label).string = stdItem.Remark;\r\n        let layout = this.infoView.getChildByPath(\"layout\");\r\n        for (let i = 0, len = Math.max(stdItem.SkipGet?.length || 0, layout.children.length); i < len; i++) {\r\n            let child = layout.children[i];\r\n            if (!child) {\r\n                child = instantiate(layout.children[0]);\r\n                layout.addChild(child);\r\n            }\r\n            let stdFetch = fetchs[stdItem?.SkipGet?.[i]];\r\n            child.getChildByName(\"goto\").off(Input.EventType.TOUCH_END);\r\n            if (stdFetch) {\r\n                child.active = true;\r\n                child['fetch'] = stdFetch.Win;\r\n                child.getChildByName(\"descLab\").getComponent(Label).string = stdFetch.Desc;\r\n                child.getChildByName(\"goto\").on(Input.EventType.TOUCH_END, this.goto, child);\r\n            } else {\r\n                child.active = false;\r\n            }\r\n        }\r\n        this.find(\"infoView/useBtn\").active = false;\r\n        this.find(\"infoView/tradeBtn\").active = false;\r\n        if (this.selector?.Button?.indexOf(3) != -1) {\r\n            this.find(\"infoView/useBtn\").active = true;\r\n        }\r\n        if (this.selector?.Button?.indexOf(1) != -1) {\r\n            this.find(\"infoView/tradeBtn\").active = true;\r\n        }\r\n    }\r\n    protected goto(e: EventTouch) {\r\n        let win = this['fetch'];\r\n        Goto(win);\r\n    }\r\n\r\n    protected onUse() {\r\n        Goto(\"OpenBoxPanel\", this.selector);\r\n    }\r\n    protected ontrade() {\r\n        Tips.Show(\"暂未开启\");\r\n    }\r\n}\r\n"]}